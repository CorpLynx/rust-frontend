name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          release_name: Prometheus ${{ steps.get_version.outputs.version }}
          draft: false
          prerelease: false
          body: |
            ## Prometheus ${{ steps.get_version.outputs.version }}
            
            ### Installation
            
            **Linux:**
            ```bash
            curl -sSL https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.version }}/prometheus-linux-installer.sh | bash
            ```
            
            **macOS:**
            ```bash
            curl -sSL https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.version }}/prometheus-macos-installer.sh | bash
            ```
            
            **Windows:**
            Download and run `prometheus-windows-installer.exe`
            
            ### What's Changed
            - See commit history for details
            
            ### Full Changelog
            https://github.com/${{ github.repository }}/compare/...

  build-linux:
    name: Build Linux Installer
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build prometheus-cli
        run: |
          cargo build --release -p prometheus-cli
      
      - name: Create Linux installer package
        run: |
          mkdir -p dist/linux
          cp target/release/prometheus-cli dist/linux/
          cp -r docs dist/linux/
          cp README.md dist/linux/
          cp config.toml dist/linux/
          
          # Create self-extracting installer script
          cat > dist/prometheus-linux-installer.sh << 'INSTALLER_EOF'
#!/bin/bash
# Prometheus CLI - Linux Full Installer
# This script installs Prometheus CLI and all dependencies

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_info() { echo -e "${BLUE}â„¹${NC} $1"; }
print_success() { echo -e "${GREEN}âœ“${NC} $1"; }
print_error() { echo -e "${RED}âœ—${NC} $1"; }
print_header() {
    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

INSTALL_DIR="${INSTALL_DIR:-$HOME/.prometheus}"
BIN_DIR="${BIN_DIR:-$HOME/.local/bin}"
CONFIG_DIR="${CONFIG_DIR:-$HOME/.config/prometheus}"

print_header "Prometheus CLI Installer"
print_info "Version: ${{ needs.create-release.outputs.version }}"

# Detect distribution
if [ -f /etc/os-release ]; then
    . /etc/os-release
    DISTRO=$ID
else
    DISTRO="unknown"
fi

print_info "Detected distribution: $DISTRO"

# Install system dependencies
print_header "Installing System Dependencies"
case "$DISTRO" in
    ubuntu|debian|pop|linuxmint)
        sudo apt-get update
        sudo apt-get install -y curl git build-essential pkg-config libssl-dev ca-certificates
        ;;
    fedora|rhel|centos|rocky|almalinux)
        if command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y curl git gcc gcc-c++ make openssl-devel pkg-config ca-certificates
        else
            sudo yum install -y curl git gcc gcc-c++ make openssl-devel pkg-config ca-certificates
        fi
        ;;
    arch|manjaro|endeavouros)
        sudo pacman -Sy --noconfirm curl git base-devel openssl pkg-config ca-certificates
        ;;
    *)
        print_error "Unsupported distribution: $DISTRO"
        print_info "Please install manually: curl, git, gcc, make, openssl-dev, pkg-config"
        exit 1
        ;;
esac
print_success "System dependencies installed"

# Install Rust
print_header "Installing Rust"
if ! command -v rustc >/dev/null 2>&1; then
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
    print_success "Rust installed"
else
    print_success "Rust already installed"
fi

# Install Ollama
print_header "Installing Ollama"
if ! command -v ollama >/dev/null 2>&1; then
    curl -fsSL https://ollama.com/install.sh | sh
    print_success "Ollama installed"
else
    print_success "Ollama already installed"
fi

# Extract and install binary
print_header "Installing Prometheus CLI"
ARCHIVE_LINE=$(awk '/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }' "$0")
mkdir -p "$INSTALL_DIR"
tail -n+$ARCHIVE_LINE "$0" | tar xzf - -C "$INSTALL_DIR"

mkdir -p "$BIN_DIR"
cp "$INSTALL_DIR/prometheus-cli" "$BIN_DIR/"
chmod +x "$BIN_DIR/prometheus-cli"
print_success "Binary installed to $BIN_DIR/prometheus-cli"

# Setup configuration
print_header "Setting Up Configuration"
mkdir -p "$CONFIG_DIR"
if [ ! -f "$CONFIG_DIR/config.toml" ]; then
    cp "$INSTALL_DIR/config.toml" "$CONFIG_DIR/"
    print_success "Configuration created"
else
    print_success "Configuration already exists"
fi

# Setup shell integration
SHELL_NAME=$(basename "$SHELL")
case "$SHELL_NAME" in
    bash) SHELL_RC="$HOME/.bashrc" ;;
    zsh) SHELL_RC="$HOME/.zshrc" ;;
    *) SHELL_RC="" ;;
esac

if [ -n "$SHELL_RC" ]; then
    if [[ ":$PATH:" != *":$BIN_DIR:"* ]]; then
        echo "" >> "$SHELL_RC"
        echo "# Prometheus CLI" >> "$SHELL_RC"
        echo "export PATH=\"$BIN_DIR:\$PATH\"" >> "$SHELL_RC"
    fi
    if ! grep -q "alias prometheus=" "$SHELL_RC" 2>/dev/null; then
        echo "alias prometheus='prometheus-cli'" >> "$SHELL_RC"
    fi
    print_success "Shell integration configured"
fi

# Install man page
if [ -f "$INSTALL_DIR/docs/prometheus-cli.1" ]; then
    MAN_DIR="$HOME/.local/share/man/man1"
    mkdir -p "$MAN_DIR"
    cp "$INSTALL_DIR/docs/prometheus-cli.1" "$MAN_DIR/"
    print_success "Man page installed"
fi

print_header "Installation Complete!"
echo "ðŸš€ Quick start:"
echo "   1. Restart your terminal or run: source ~/.${SHELL_NAME}rc"
echo "   2. Start Ollama: ollama serve"
echo "   3. Run: prometheus-cli"
echo ""
echo "ðŸ“š Documentation: man prometheus-cli"

exit 0

__ARCHIVE_BELOW__
INSTALLER_EOF
          
          # Append tarball to installer
          cd dist/linux
          tar czf - prometheus-cli docs config.toml README.md >> ../prometheus-linux-installer.sh
          cd ../..
          
          chmod +x dist/prometheus-linux-installer.sh
      
      - name: Upload Linux installer
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./dist/prometheus-linux-installer.sh
          asset_name: prometheus-linux-installer.sh
          asset_content_type: application/x-sh

  build-macos:
    name: Build macOS Installer
    needs: create-release
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build prometheus-cli
        run: |
          cargo build --release -p prometheus-cli
      
      - name: Create macOS installer package
        run: |
          mkdir -p dist/macos
          cp target/release/prometheus-cli dist/macos/
          cp -r docs dist/macos/
          cp README.md dist/macos/
          cp config.toml dist/macos/
          
          # Create self-extracting installer script
          cat > dist/prometheus-macos-installer.sh << 'INSTALLER_EOF'
#!/bin/bash
# Prometheus CLI - macOS Full Installer
# This script installs Prometheus CLI and all dependencies

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_info() { echo -e "${BLUE}â„¹${NC} $1"; }
print_success() { echo -e "${GREEN}âœ“${NC} $1"; }
print_error() { echo -e "${RED}âœ—${NC} $1"; }
print_header() {
    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

BIN_DIR="${BIN_DIR:-/usr/local/bin}"
CONFIG_DIR="${CONFIG_DIR:-$HOME/.config/prometheus}"
INSTALL_DIR="$HOME/.prometheus"

print_header "Prometheus CLI Installer for macOS"
print_info "Version: ${{ needs.create-release.outputs.version }}"

# Check macOS
if [[ "$OSTYPE" != "darwin"* ]]; then
    print_error "This installer is for macOS only"
    exit 1
fi

# Install Homebrew
print_header "Installing Homebrew"
if ! command -v brew >/dev/null 2>&1; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    if [[ $(uname -m) == "arm64" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
    print_success "Homebrew installed"
else
    print_success "Homebrew already installed"
fi

# Install Rust
print_header "Installing Rust"
if ! command -v rustc >/dev/null 2>&1; then
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
    print_success "Rust installed"
else
    print_success "Rust already installed"
fi

# Install Ollama
print_header "Installing Ollama"
if ! command -v ollama >/dev/null 2>&1; then
    curl -fsSL https://ollama.com/install.sh | sh
    print_success "Ollama installed"
else
    print_success "Ollama already installed"
fi

# Extract and install binary
print_header "Installing Prometheus CLI"
ARCHIVE_LINE=$(awk '/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }' "$0")
mkdir -p "$INSTALL_DIR"
tail -n+$ARCHIVE_LINE "$0" | tar xzf - -C "$INSTALL_DIR"

if [ -w "$BIN_DIR" ]; then
    cp "$INSTALL_DIR/prometheus-cli" "$BIN_DIR/"
else
    sudo cp "$INSTALL_DIR/prometheus-cli" "$BIN_DIR/"
fi
chmod +x "$BIN_DIR/prometheus-cli"
print_success "Binary installed to $BIN_DIR/prometheus-cli"

# Setup configuration
print_header "Setting Up Configuration"
mkdir -p "$CONFIG_DIR"
if [ ! -f "$CONFIG_DIR/config.toml" ]; then
    cp "$INSTALL_DIR/config.toml" "$CONFIG_DIR/"
    print_success "Configuration created"
else
    print_success "Configuration already exists"
fi

# Setup shell integration
SHELL_NAME=$(basename "$SHELL")
case "$SHELL_NAME" in
    zsh) SHELL_RC="$HOME/.zshrc" ;;
    bash) SHELL_RC="$HOME/.bashrc" ;;
    *) SHELL_RC="" ;;
esac

if [ -n "$SHELL_RC" ]; then
    if ! grep -q "alias prometheus=" "$SHELL_RC" 2>/dev/null; then
        echo "" >> "$SHELL_RC"
        echo "# Prometheus CLI" >> "$SHELL_RC"
        echo "alias prometheus='prometheus-cli'" >> "$SHELL_RC"
    fi
    print_success "Shell integration configured"
fi

# Install man page
if [ -f "$INSTALL_DIR/docs/prometheus-cli.1" ]; then
    MAN_DIR="/usr/local/share/man/man1"
    sudo mkdir -p "$MAN_DIR"
    sudo cp "$INSTALL_DIR/docs/prometheus-cli.1" "$MAN_DIR/"
    print_success "Man page installed"
fi

print_header "Installation Complete!"
echo "ðŸš€ Quick start:"
echo "   1. Restart your terminal or run: source ~/.${SHELL_NAME}rc"
echo "   2. Start Ollama: ollama serve"
echo "   3. Run: prometheus-cli"
echo ""
echo "ðŸ“š Documentation: man prometheus-cli"

exit 0

__ARCHIVE_BELOW__
INSTALLER_EOF
          
          # Append tarball to installer
          cd dist/macos
          tar czf - prometheus-cli docs config.toml README.md >> ../prometheus-macos-installer.sh
          cd ../..
          
          chmod +x dist/prometheus-macos-installer.sh
      
      - name: Upload macOS installer
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./dist/prometheus-macos-installer.sh
          asset_name: prometheus-macos-installer.sh
          asset_content_type: application/x-sh

  build-windows:
    name: Build Windows Installer
    needs: create-release
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build prometheus-cli
        run: |
          cargo build --release -p prometheus-cli
      
      - name: Install NSIS
        run: |
          choco install nsis -y
      
      - name: Create Windows installer script
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist\windows
          Copy-Item target\release\prometheus-cli.exe dist\windows\
          Copy-Item README.md dist\windows\
          Copy-Item config.toml dist\windows\
          Copy-Item -Recurse docs dist\windows\
          
          # Create NSIS installer script
          @'
!include "MUI2.nsh"
!include "FileFunc.nsh"

Name "Prometheus CLI"
OutFile "prometheus-windows-installer.exe"
InstallDir "$LOCALAPPDATA\Prometheus"
RequestExecutionLevel user

!define MUI_ABORTWARNING
!define MUI_ICON "${NSISDIR}\Contrib\Graphics\Icons\modern-install.ico"

!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES

!insertmacro MUI_LANGUAGE "English"

Section "Install"
    SetOutPath "$INSTDIR"
    
    File "prometheus-cli.exe"
    File "config.toml"
    File "README.md"
    File /r "docs"
    
    CreateDirectory "$INSTDIR\conversations"
    CreateDirectory "$APPDATA\prometheus"
    
    IfFileExists "$APPDATA\prometheus\config.toml" +2 0
    CopyFiles "$INSTDIR\config.toml" "$APPDATA\prometheus\config.toml"
    
    WriteUninstaller "$INSTDIR\Uninstall.exe"
    
    CreateDirectory "$SMPROGRAMS\Prometheus"
    CreateShortcut "$SMPROGRAMS\Prometheus\Prometheus CLI.lnk" "$INSTDIR\prometheus-cli.exe"
    CreateShortcut "$SMPROGRAMS\Prometheus\Uninstall.lnk" "$INSTDIR\Uninstall.exe"
    CreateShortcut "$DESKTOP\Prometheus CLI.lnk" "$INSTDIR\prometheus-cli.exe"
    
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Prometheus" "DisplayName" "Prometheus CLI"
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Prometheus" "UninstallString" "$INSTDIR\Uninstall.exe"
    WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Prometheus" "DisplayVersion" "${{ needs.create-release.outputs.version }}"
    
    EnVar::AddValue "PATH" "$INSTDIR"
    
    MessageBox MB_YESNO "Prometheus CLI has been installed.$\n$\nDo you want to install dependencies (Rust and Ollama)?" IDYES install_deps IDNO skip_deps
    
    install_deps:
        DetailPrint "Installing Rust..."
        NSISdl::download "https://win.rustup.rs/x86_64" "$TEMP\rustup-init.exe"
        ExecWait '"$TEMP\rustup-init.exe" -y'
        Delete "$TEMP\rustup-init.exe"
        
        DetailPrint "Installing Ollama..."
        NSISdl::download "https://ollama.com/download/OllamaSetup.exe" "$TEMP\OllamaSetup.exe"
        ExecWait '"$TEMP\OllamaSetup.exe" /S'
        Delete "$TEMP\OllamaSetup.exe"
        
        MessageBox MB_OK "Dependencies installed. Please restart your terminal."
    
    skip_deps:
SectionEnd

Section "Uninstall"
    Delete "$INSTDIR\prometheus-cli.exe"
    Delete "$INSTDIR\config.toml"
    Delete "$INSTDIR\README.md"
    Delete "$INSTDIR\Uninstall.exe"
    RMDir /r "$INSTDIR\docs"
    RMDir "$INSTDIR"
    
    Delete "$SMPROGRAMS\Prometheus\Prometheus CLI.lnk"
    Delete "$SMPROGRAMS\Prometheus\Uninstall.lnk"
    RMDir "$SMPROGRAMS\Prometheus"
    Delete "$DESKTOP\Prometheus CLI.lnk"
    
    DeleteRegKey HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\Prometheus"
    
    EnVar::DeleteValue "PATH" "$INSTDIR"
SectionEnd
'@ | Out-File -FilePath dist\windows\installer.nsi -Encoding ASCII
      
      - name: Build Windows installer
        shell: pwsh
        run: |
          cd dist\windows
          & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi
          Move-Item prometheus-windows-installer.exe ..\
      
      - name: Upload Windows installer
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./dist/prometheus-windows-installer.exe
          asset_name: prometheus-windows-installer.exe
          asset_content_type: application/octet-stream
